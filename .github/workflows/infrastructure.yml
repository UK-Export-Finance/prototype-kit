name: Infrastructure setup 🔨
run-name: Prototype kit base infrastructure

on:
  push:
    branches:
      - feat/pipelines

env:
  environment: infrastructure
  resourceGroupName: rg-prototypekit-dev-001
  timezone: 'Europe/London'

jobs:
  setup:
    name: Setup infrastructure variables 🔧
    runs-on: ubuntu-latest      
    outputs:
      environment: ${{ env.environment }}
      timezone: ${{ env.timezone }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Environment 🧪
        run: echo "Environment set to ${{ env.environment }}"
      - name: Timezone 🌐
        run: echo "Timezone set to ${{ env.timezone }}"

  base:
    name: Base infrastructure creation 🧱
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      environment: ${{ env.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
    
      - name: Login 🔐
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}          

      - name: Deploy Resource group 🏗️
        uses: Azure/cli@v1.0.7
        with:
          inlineScript: |
            az group create -n ${{ vars.AZURE_RG }} -l ${{ secrets.AZURE_LOCATION }}
                     
          # Deploy Container Registry
      - name: Container registry 📦️
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ vars.AZURE_SUBSCRIPTION }}
          scope: resourcegroup
          resourceGroupName: ${{ vars.AZURE_RG }}
          region: ${{ vars.AZURE_REGION }}
          template: ./.github/actions/container_registry.bicep
                          
              
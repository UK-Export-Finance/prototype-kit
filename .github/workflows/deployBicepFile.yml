name: Infrastructure ğŸ”¨
run-name: Prototypekit base infrastructure build from ${{ github.repository }}

on:
  push:
    branches:
      - feat/infrastructure

    paths: [.github/workflows/deployBicepFile.yml]

env:
  product: Prototypekit
  environment: infrastructure
  resourceGroupName: rg-prototypekit-dev-001
  timezone: 'Europe/London'
  # Deployment environment target i.e., `dev`, `staging`, `prod`
  target: ${{ vars.environment }}

jobs:
  # 1. Setup infrastructure variables
  setup:
    name: Setup ğŸ”§
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ env.environment }}
      timezone: ${{ env.timezone }}
    steps:
      - name: Environment ğŸ§ª
        run: echo "Environment set to ${{ env.environment }}"

      - name: Timezone ğŸŒ
        run: echo "Timezone set to ${{ env.timezone }}"

  # 2. Base infrastructure creation
  base:
    name: Base ğŸ§±
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      environment: ${{ env.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Login ğŸ”
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
         # Deploy Bicep file
      - name: deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: rg-prototypekit-dev-001
          template: $env:BUILD_SOURCESDIRECTORY/main.bicep
          parameters: 'storagePrefix=saprototypekitdev storageSKU=Standard_LRS'
          failOnStdErr: false   

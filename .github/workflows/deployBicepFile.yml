name: Infrastructure üî®
run-name: Prototypekit base infrastructure build from ${{ github.repository }}

on:
  push:
    branches:
      - feat/infrastructure

    paths: [.github/workflows/deployBicepFile.yml]

env:
  product: Prototypekit
  environment: infrastructure
  resourceGroupName: rg-prototypekit-dev-001
  timezone: 'Europe/London'
  # Deployment environment target i.e., `feat/intrastructure`, `main`, `prod`
  target: ${{ vars.environment }}

jobs:
  # 1. Setup infrastructure variables
  setup:
    name: Setup üîß
    runs-on: ubuntu-latest      
    outputs:
      environment: ${{ env.environment }}
      timezone: ${{ env.timezone }}
    steps:
      # Checkout latest commit
      - name: 1. Latest commit
        uses: actions/checkout@v3
    
      - name: Environment üß™
        run: echo "Environment set to ${{ env.environment }}"

      - name: Timezone üåê
        run: echo "Timezone set to ${{ env.timezone }}"
        
       

  # 2. Base infrastructure creation
  base:
    name: Base üß±
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      environment: ${{ env.environment }}
    runs-on: ubuntu-latest
    steps:      
      # Checkout latest commit
      - name: 1. Latest commit
        uses: actions/checkout@v3
    
    
      - name: Pre-production üí´
        if: contains('["feat/infrastructure", "main"]', env.target)
        run: echo "type=Preproduction" >> $GITHUB_ENV
        
      - name: Tags üè∑Ô∏è
        run: echo tags='Environment=${{ env.type }}' \
          'Product=${{ env.product }}' \
          'Team=development' >> $GITHUB_ENV  
    
      - name: Login üîê
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

          # Deploy App Service Plan and App Service
      - name: App Service
        uses: azure/arm-deploy@v1
        with:
          resourceGroupName: ${{ vars.AZURE_RG }}
          subscriptionId: ${{ vars.AZURE_SUBSCRIPTION }}
          template: ./createNewAppSer.bicep 
           

          # Deploy Resource group
      - name: Resource group üèóÔ∏è
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ vars.AZURE_SUBSCRIPTION }}
          scope: subscription
          resourceGroupName: rg-prototypekit-dev-001
          region: UK South


          # Deploy Container Registry
      - name: Container registry üì¶Ô∏è
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ vars.AZURE_SUBSCRIPTION }}
          scope: resourcegroup
          resourceGroupName: rg-prototypekit-dev-001
          region: UK South
          template: ./createNewCR.bicep   

          # Deploy Virtual Network
      - name: Virtual network üßµ
        uses: azure/arm-deploy@v1
        with:
          resourceGroupName: ${{ vars.AZURE_RG }}
          subscriptionId: ${{ vars.AZURE_SUBSCRIPTION }}
          template: ./createNewVNet.bicep     
             
          
           
          
             
          
           
          
              # Deploy Storage Account
      - name: Storage Account
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: rg-prototypekit-dev-001
          template: ./main.bicep
          parameters: 'storagePrefix=saprokitdev storageSKU=Standard_LRS'
          failOnStdErr: false
